<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PrayTogether Admin Panel</title>
    <link rel="icon" type="image/png" href="app_icon.png">
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <div id="app"></div>
    <div id="modal-container"></div>

    <!-- Core Scripts -->
    <script src="js/config.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/api.js"></script>
    <script src="js/state.js"></script>
    <script src="js/utils.js"></script>

    <!-- Component Scripts -->
    <script src="js/components/header.js"></script>
    <script src="js/components/tabs.js"></script>
    <script src="js/components/modal.js"></script>
    <script src="js/components/stats.js"></script>

    <!-- Page Scripts -->
    <script src="js/pages/dashboard.js"></script>
    <script src="js/pages/users.js"></script>
    <script src="js/pages/prayers.js"></script>
    <script src="js/pages/reports.js"></script>
    <script src="js/pages/notifications.js"></script>

    <!-- Main App Script -->
    <script>
        // Main App
        const App = {
            init() {
                // Check authentication
                if (!Auth.requireAuth()) {
                    return;
                }

                // Subscribe to state changes
                State.subscribe(() => {
                    this.render();
                });

                // Load initial data
                this.loadData();
            },

            async loadData() {
                State.setLoading(true);
                
                try {
                    // Load dashboard data
                    const dashboardData = await API.getDashboard();
                    if (dashboardData && dashboardData.success) {
                        State.setDashboard(dashboardData.data);
                    }

                    // Load other data based on active tab
                    const activeTab = State.get().activeTab;
                    
                    if (activeTab === 'users') {
                        await this.loadUsers();
                    } else if (activeTab === 'prayers') {
                        await this.loadPrayers();
                    } else if (activeTab === 'reports') {
                        await this.loadReports();
                    }
                } catch (error) {
                    console.error('Load data error:', error);
                } finally {
                    State.setLoading(false);
                }
            },

            async loadUsers() {
                try {
                    const usersData = await API.getUsers();
                    if (usersData && usersData.success) {
                        State.setUsers(usersData.users);
                    }
                } catch (error) {
                    console.error('Load users error:', error);
                }
            },

            async loadPrayers() {
                try {
                    const prayersData = await API.getPrayers();
                    if (prayersData && prayersData.success) {
                        State.setPrayers(prayersData.prayers);
                    }
                } catch (error) {
                    console.error('Load prayers error:', error);
                }
            },

            async loadReports() {
                try {
                    const reportsData = await API.getReports();
                    if (reportsData && reportsData.success) {
                        State.setReports(reportsData.reports);
                    }
                } catch (error) {
                    console.error('Load reports error:', error);
                }
            },

            async refreshData() {
                await this.loadData();
            },

            render() {
                const state = State.get();
                const app = document.getElementById('app');
                
                app.innerHTML = `
                    ${Modal.render()}
                    <div class="min-h-screen bg-gray-100">
                        ${Header.render()}
                        ${Tabs.render()}
                        
                        <div class="container py-8">
                            ${this.renderCurrentPage()}
                        </div>
                    </div>
                `;

                // Initialize notifications page if active
                if (state.activeTab === 'notifications') {
                    setTimeout(() => NotificationsPage.init(), 0);
                }
            },

            renderCurrentPage() {
                const state = State.get();
                
                switch (state.activeTab) {
                    case 'dashboard':
                        return DashboardPage.render();
                    case 'users':
                        return UsersPage.render();
                    case 'prayers':
                        return PrayersPage.render();
                    case 'reports':
                        return ReportsPage.render();
                    case 'notifications':
                        return NotificationsPage.render();
                    default:
                        return '<div class="text-center py-8 text-gray-500">Sayfa bulunamadÄ±</div>';
                }
            }
        };

        // Override State.setActiveTab to load data when tab changes
        const originalSetActiveTab = State.setActiveTab.bind(State);
        State.setActiveTab = function(tab) {
            originalSetActiveTab(tab);
            
            // Load data for the new tab
            if (tab === 'users') {
                App.loadUsers();
            } else if (tab === 'prayers') {
                App.loadPrayers();
            } else if (tab === 'reports') {
                App.loadReports();
            }
        };

        // Initialize app
        App.init();
    </script>
</body>
</html>